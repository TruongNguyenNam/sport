package com.example.storesports.core.admin.order.controller;

import com.example.storesports.core.admin.order.payload.*;
import com.example.storesports.core.admin.product.payload.ProductResponse;
import com.example.storesports.entity.Order;
import com.example.storesports.infrastructure.constant.OrderStatus;
import com.example.storesports.infrastructure.utils.ResponseData;
import com.example.storesports.service.admin.order.OrderService;
import com.example.storesports.service.admin.order.impl.OrderServiceImpl;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDate;
import java.util.List;

@RestController
@RequestMapping("/api/v1/admin/order")
@RequiredArgsConstructor
@Slf4j
public class OrderController {
    private final OrderService orderService;


    @GetMapping("/status-counts")
    public ResponseData<List<OrderStatusCount>> getOrderStatusCounts() {
        List<OrderStatusCount> counts = orderService.getOrderStatusCounts();
        return ResponseData.<List<OrderStatusCount>>builder()
                .status(HttpStatus.OK.value())
                .message("L·∫•y s·ªë l∆∞·ª£ng tr·∫°ng th√°i ƒë∆°n h√†ng th√†nh c√¥ng")
                .data(counts)
                .build();
    }

    @GetMapping("/status")
    public ResponseData<List<OrderResponse>> getOrdersByStatus(@RequestParam("status") OrderStatus orderStatus) {
        List<OrderResponse> orders = orderService.getAllOrderStatus(orderStatus);

        return ResponseData.<List<OrderResponse>>builder()
                .status(HttpStatus.OK.value())
                .message("L·∫•y danh s√°ch ƒë∆°n h√†ng theo tr·∫°ng th√°i th√†nh c√¥ng")
                .data(orders)
                .build();
    }

    // cai edit n√†y sai v√† add sai
    @PostMapping("/{orderCode}/add-product-v2")
    public ResponseData<OrderResponse> addProductToOrderV2(
            @PathVariable("orderCode") String orderCode,
            @Valid @RequestBody OrderRequest request
    ) {
        log.info("Received request to add products to order: {}", orderCode);
        try {
            request.setOrderCode(orderCode);
            OrderResponse response = orderService.addProductToOrderV2(request);
            return ResponseData.<OrderResponse>builder()
                    .status(HttpStatus.CREATED.value())
                    .message("ƒê√£ th√™m s·∫£n ph·∫©m v√†o ƒë∆°n h√†ng")
                    .data(response)
                    .build();
        } catch (IllegalArgumentException e) {
            log.error("Error adding products to order {}: {}", orderCode, e.getMessage());
            return ResponseData.<OrderResponse>builder()
                    .status(HttpStatus.BAD_REQUEST.value())
                    .message(e.getMessage())
                    .data(null)
                    .build();
        } catch (Exception e) {
            log.error("Unexpected error adding products to order {}: {}", orderCode, e.getMessage());
            return ResponseData.<OrderResponse>builder()
                    .status(HttpStatus.INTERNAL_SERVER_ERROR.value())
                    .message("L·ªói server: " + e.getMessage())
                    .data(null)
                    .build();
        }
    }


    @PutMapping("/{orderCode}/edit-items")
    public ResponseData<OrderResponse> updateOrder(
            @PathVariable("orderCode") String orderCode,
            @Valid @RequestBody OrderRequest request) {
        log.info("Nh·∫≠n y√™u c·∫ßu c·∫≠p nh·∫≠t ƒë∆°n h√†ng: {}", orderCode);
        try {
            request.setOrderCode(orderCode);
            OrderResponse response = orderService.editOrderItems(orderCode, request);
            return ResponseData.<OrderResponse>builder()
                    .status(HttpStatus.OK.value())
                    .message("C·∫≠p nh·∫≠t ƒë∆°n h√†ng th√†nh c√¥ng")
                    .data(response)
                    .build();
        } catch (IllegalArgumentException e) {
            log.error("L·ªói khi c·∫≠p nh·∫≠t ƒë∆°n h√†ng {}: {}", orderCode, e.getMessage());
            return ResponseData.<OrderResponse>builder()
                    .status(HttpStatus.BAD_REQUEST.value())
                    .message(e.getMessage())
                    .data(null)
                    .build();
        } catch (Exception e) {
            log.error("L·ªói h·ªá th·ªëng khi c·∫≠p nh·∫≠t ƒë∆°n h√†ng {}: {}", orderCode, e.getMessage());
            return ResponseData.<OrderResponse>builder()
                    .status(HttpStatus.INTERNAL_SERVER_ERROR.value())
                    .message("L·ªói server: " + e.getMessage())
                    .data(null)
                    .build();
        }
    }

    @PutMapping("/{orderCode}")
    public ResponseData<OrderResponse> updateOrder(@PathVariable String orderCode, @RequestBody UpdateOrderRequest request) {
        request.setOrderCode(orderCode);
        OrderResponse response = orderService.updateOrder(request);
        return ResponseData.<OrderResponse>builder()
                .status(HttpStatus.OK.value())
                .message("C·∫≠p nh·∫≠t ƒë∆°n h√†ng th√†nh c√¥ng")
                .data(response)
                .build();
    }


    @GetMapping("/findByShip")
    public ResponseData<List<OrderResponse>> findByShip() {
        List<OrderResponse> orders = orderService.getAllByShip();
        return ResponseData.<List<OrderResponse>>builder()
                .status(HttpStatus.OK.value())
                .message("danh s√°ch ƒë∆°n h√†ng")
                .data(orders)
                .build();
    }

    @PutMapping("/{orderCode}/update-status")
    public ResponseData<OrderResponse> updateOrderStatus(
            @PathVariable("orderCode") String orderCode,
            @RequestBody UpdateOrderStatusRequest request) {

        try {
            // Ki·ªÉm tra tr·∫°ng th√°i m·ªõi c√≥ null kh√¥ng
            if (request.getNewStatus() == null) {
                return ResponseData.<OrderResponse>builder()
                        .status(HttpStatus.BAD_REQUEST.value())
                        .message("Tr·∫°ng th√°i m·ªõi (newStatus) kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
                        .data(null)
                        .build();
            }

            // G·ªçi service c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng
            OrderResponse response = orderService.updateOrderStatus(
                    orderCode,
                    request.getNewStatus(),
                    request.getNodes()
            );

            return ResponseData.<OrderResponse>builder()
                    .status(HttpStatus.OK.value())
                    .message("C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng th√†nh c√¥ng")
                    .data(response)
                    .build();

        } catch (IllegalArgumentException e) {
            return ResponseData.<OrderResponse>builder()
                    .status(HttpStatus.BAD_REQUEST.value())
                    .message(e.getMessage())
                    .data(null)
                    .build();

        } catch (Exception e) {
            return ResponseData.<OrderResponse>builder()
                    .status(HttpStatus.INTERNAL_SERVER_ERROR.value())
                    .message("L·ªói server: " + e.getMessage())
                    .data(null)
                    .build();
        }
    }


    @PostMapping
    public ResponseData<OrderResponse> createOrder(@RequestBody CreateInvoiceRequest request) {
        try {
            OrderResponse response = orderService.createInvoice(request);
            return ResponseData.<OrderResponse>builder()
                    .status(HttpStatus.CREATED.value())
                    .message("T·∫°o ƒë∆°n h√†ng th√†nh c√¥ng")
                    .data(response)
                    .build();
        } catch (IllegalArgumentException e) {
            return ResponseData.<OrderResponse>builder()
                    .status(HttpStatus.BAD_REQUEST.value())
                    .message("Y√™u c·∫ßu kh√¥ng h·ª£p l·ªá: " + e.getMessage())
                    .data(null)
                    .build();
        } catch (Exception e) {
            e.printStackTrace();
            return ResponseData.<OrderResponse>builder()
                    .status(HttpStatus.INTERNAL_SERVER_ERROR.value())
                    .message("L·ªói server: " + e.getMessage())
                    .data(null)
                    .build();
        }
    }


    @GetMapping("/pos")
    public ResponseData<List<OrderResponse>> getAllPosOrders() {
        List<OrderResponse> orders = orderService.getAll();
        return ResponseData.<List<OrderResponse>>builder()
                .status(HttpStatus.OK.value())
                .message("L·∫•y danh s√°ch ƒë∆°n h√†ng POS th√†nh c√¥ng")
                .data(orders)
                .build();
    }

    //ƒë√¢y l√† c√°i add s·∫£n ph·∫©m v√†o ƒë∆°n h√†ng chu·∫©n v√† thanh to√°n
    @PostMapping("/{orderCode}/products")
    public ResponseData<OrderResponse> addProductToOrder(
            @PathVariable String orderCode,
            @RequestBody OrderRequest request,
            HttpServletRequest httpServletRequest) {
        log.info("üì• Add product to order {} with payload: {}", orderCode, request);
        request.setOrderCode(orderCode);
        OrderResponse response = orderService.addProductToOrderV3(request,httpServletRequest);
        return ResponseData.<OrderResponse>builder()
                .status(HttpStatus.OK.value())
                .message("Th√™m s·∫£n ph·∫©m v√†o ƒë∆°n h√†ng th√†nh c√¥ng")
                .data(response)
                .build();
    }


    @GetMapping("/{id}")
    public ResponseData<OrderResponse> findById(@PathVariable(name = "id") Long id){
        OrderResponse response = orderService.findById(id);
        return ResponseData.<OrderResponse>builder()
                .status(HttpStatus.OK.value())
                .message("th√¥ng tin c·ªßa ƒë∆°n h√†ng")
                .data(response)
                .build();
    }



    @GetMapping("/chart/monthly-orders")
    public ResponseData<List<MonthlyOrderTypeResponse>> getMonthlyOrderChart() {
        List<MonthlyOrderTypeResponse> data = orderService.getMonthlyOrderChart();
        return ResponseData.<List<MonthlyOrderTypeResponse>>builder()
                .status(HttpStatus.OK.value())
                .message("Th·ªëng k√™ ƒë∆°n h√†ng theo th√°ng (b√°n th∆∞·ªùng & ship)")
                .data(data)
                .build();
    }


    // Th·ªëng Ke doanh thu theo th√°ng v·ªõi tr·∫°ng th√°i ƒë√£ ho√†n th√†nh v√† ƒë√£ thanh to√°n
    @GetMapping("/revenue/daily")
    public ResponseData<List<DailyRevenueResponse>> getDailyRevenue() {
        List<DailyRevenueResponse> revenueList = orderService.getDailyRevenue();
        return ResponseData.<List<DailyRevenueResponse>>builder()
                .status(HttpStatus.OK.value())
                .message("Th·ªëng k√™ doanh thu theo ng√†y h√¥m nay")
                .data(revenueList)
                .build();
    }
    @GetMapping("/revenue/monthly")
    public ResponseData<List<MonthlyRevenueResponse>> getMonthlyRevenue() {
        List<MonthlyRevenueResponse> revenueList = orderService.getMonthlyRevenue();
        return ResponseData.<List<MonthlyRevenueResponse>>builder()
                .status(HttpStatus.OK.value())
                .message("Th·ªëng k√™ doanh thu theo th√°ng")
                .data(revenueList)
                .build();
    }

    @GetMapping("/revenue/yearly")
    public ResponseData<List<YearlyRevenueResponse>> getYearlyRevenue() {
        List<YearlyRevenueResponse> revenueList = orderService.getYearlyRevenue();
        return ResponseData.<List<YearlyRevenueResponse>>builder()
                .status(HttpStatus.OK.value())
                .message("Th·ªëng k√™ doanh thu theo nƒÉm")
                .data(revenueList)
                .build();
    }
    // Th·ªëng k√™ s·ªë l∆∞·ª£ng ƒë∆°n h√†ng ƒë√£ h·ªßy h√¥m nay
    @GetMapping("/cancelled/today")
    public ResponseData<OrderStatusTodayResponse> getCancelledToday() {
        return ResponseData.<OrderStatusTodayResponse>builder()
                .status(HttpStatus.OK.value())
                .message("Th·ªëng k√™ ƒë∆°n h√†ng hu·ª∑ h√¥m nay")
                .data(orderService.getCancelledOrdersToday())
                .build();
    }
    // Th·ªëng k√™ s·ªë l∆∞·ª£ng ƒë∆°n h√†ng ƒë√£ h·ªßy trong th√°ng
    @GetMapping("/cancelled/month")
    public ResponseData<OrderStatusMonthResponse> getCancelledThisMonth() {
        return ResponseData.<OrderStatusMonthResponse>builder()
                .status(HttpStatus.OK.value())
                .message("Th·ªëng k√™ ƒë∆°n h√†ng hu·ª∑ trong th√°ng")
                .data(orderService.getCancelledOrdersThisMonth())
                .build();
    }
    // Th·ªëng k√™ s·ªë l∆∞·ª£ng ƒë∆°n h√†ng ƒë√£ h·ªßy trong nƒÉm
    @GetMapping("/cancelled/year")
    public ResponseData<OrderStatusYearResponse> getCancelledThisYear() {
        return ResponseData.<OrderStatusYearResponse>builder()
                .status(HttpStatus.OK.value())
                .message("Th·ªëng k√™ ƒë∆°n h√†ng hu·ª∑ trong nƒÉm")
                .data(orderService.getCancelledOrdersThisYear())
                .build();
    }
    // Th·ªëng k√™ s·ªë l∆∞·ª£ng ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh h√¥m nay
    @GetMapping("/completed/today")
    public ResponseData<OrderStatusTodayResponse> getCompletedToday() {
        return ResponseData.<OrderStatusTodayResponse>builder()
                .status(HttpStatus.OK.value())
                .message("Th·ªëng k√™ ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh h√¥m nay")
                .data(orderService.countCompletedOrdersToday())
                .build();
    }
    // Th·ªëng k√™ s·ªë l∆∞·ª£ng ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh trong th√°ng
    @GetMapping("/completed/month")
    public ResponseData<OrderStatusMonthResponse> getCompletedThisMonth() {
        return ResponseData.<OrderStatusMonthResponse>builder()
                .status(HttpStatus.OK.value())
                .message("Th·ªëng k√™ ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh trong th√°ng")
                .data(orderService.countCompletedOrdersThisMonth())
                .build();
    }
    // Th·ªëng k√™ s·ªë l∆∞·ª£ng ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh trong nƒÉm
    @GetMapping("/completed/year")
    public ResponseData<OrderStatusYearResponse> getCompletedThisYear() {
        return ResponseData.<OrderStatusYearResponse>builder()
                .status(HttpStatus.OK.value())
                .message("Th·ªëng k√™ ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh trong nƒÉm")
                .data(orderService.countCompletedOrdersThisYear())
                .build();
    }
    // Th·ªëng k√™ s·ªë l∆∞·ª£ng ƒë∆°n h√†ng ƒë√£ tr·∫£ l·∫°i h√¥m nay
    @GetMapping("/returned/today")
    public ResponseData<OrderStatusTodayResponse> getReturnedToday() {
        return ResponseData.<OrderStatusTodayResponse>builder()
                .status(HttpStatus.OK.value())
                .message("Th·ªëng k√™ ƒë∆°n h√†ng ƒë√£ tr·∫£ l·∫°i h√¥m nay")
                .data(orderService.getReturnedOrdersToday())
                .build();
    }
    // Th·ªëng k√™ s·ªë l∆∞·ª£ng ƒë∆°n h√†ng ƒë√£ tr·∫£ l·∫°i trong th√°ng
    @GetMapping("/returned/month")
    public ResponseData<OrderStatusMonthResponse> getReturnedThisMonth() {
        return ResponseData.<OrderStatusMonthResponse>builder()
                .status(HttpStatus.OK.value())
                .message("Th·ªëng k√™ ƒë∆°n h√†ng ƒë√£ tr·∫£ l·∫°i trong th√°ng")
                .data(orderService.getReturnedOrdersThisMonth())
                .build();
    }
    // Th·ªëng k√™ s·ªë l∆∞·ª£ng ƒë∆°n h√†ng ƒë√£ tr·∫£ l·∫°i trong nƒÉm
    @GetMapping("/returned/year")
    public ResponseData<OrderStatusYearResponse> getReturnedThisYear() {
        return ResponseData.<OrderStatusYearResponse>builder()
                .status(HttpStatus.OK.value())
                .message("Th·ªëng k√™ ƒë∆°n h√†ng ƒë√£ tr·∫£ l·∫°i trong nƒÉm")
                .data(orderService.getReturnedOrdersThisYear())
                .build();
    }
    // Th·ªëng k√™ tu·ª≥ ch·ªânh gi·ªØa hai ng√†y
    @GetMapping("/custom")
    public ResponseData<CustomStatisticalResponse> getStatisticsBetweenDates(
            @RequestParam("from") @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate fromDate,
            @RequestParam("to") @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate toDate
    ) {
        return ResponseData.<CustomStatisticalResponse>builder()
                .status(HttpStatus.OK.value())
                .message("Th·ªëng k√™ doanh thu v√† ƒë∆°n h√†ng trong kho·∫£ng th·ªùi gian")
                .data(orderService.getStatisticsBetween(fromDate, toDate))
                .build();
    }
    

}
